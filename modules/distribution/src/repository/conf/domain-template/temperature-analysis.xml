<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ Copyright (c) 2015, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<templateDomain name="TemperatureAnalysis">
    <description>Temperature Analysis Description</description>
    <templates>
        <template name="TemperatureAnalysis">
            <description>Trigger alert by specifying minimum maximum temperature values and maximum total duration
                value
            </description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                    @Plan:name('TemperatureAnalysis')

                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */

                    @Import('deviceHealthMainStream:1.0.0')
                    define stream deviceHealthMainStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature double, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                    @Import('deviceDoorMainStream:1.0.0')
                    define stream deviceDoorMainStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration long);

                    @Export('alertStream:1.0.0')
                    define stream alertStream (smartDeviceId int, gatewayId int, totalDuration long, averageTemperature double);

                    @info(name = 'query')
                    from deviceDoorMainStream#window.time($windowSize) join deviceHealthMainStream#window.time($windowSize)
                    on deviceDoorMainStream.smartDeviceId == deviceHealthMainStream.smartDeviceId
                    select deviceHealthMainStream.smartDeviceId  as smartDeviceId,
                    deviceDoorMainStream.gatewayId,
                    deviceDoorMainStream.doorOpenDuration as totalDuration,
                    deviceHealthMainStream.temperature as averageTemperature
                    having (totalDuration < $maxDurationCase1 and ( averageTemperature > $maxTemperatureCase1 or averageTemperature < $minTemperatureCase1))
					or ((totalDuration > $minDurationCase2 and totalDuration > $maxDurationCase2) and ( averageTemperature > $maxTemperatureCase2 or averageTemperature < $minTemperatureCase2))
					or ((totalDuration > $minDurationCase3 and totalDuration > $maxDurationCase3) and ( averageTemperature > $maxTemperatureCase3 or averageTemperature < $minTemperatureCase3))
					or totalDuration > $minDurationCase4
                    insert into alertStream;

                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time eg:-1 min</description>
                    <defaultValue>1 min</defaultValue>
                </parameter>

                <parameter name="maxDurationCase1" type="int">
                    <displayName>Maximum duration (case 1)</displayName>
                    <description>Maximum duration of between time windows in seconds</description>
                    <defaultValue>120</defaultValue>
                </parameter>

                <parameter name="minTemperatureCase1" type="int">
                    <displayName>Minimum temperature (case 1)</displayName>
                    <description>Minimum temperature average temperature should be</description>
                    <defaultValue>2</defaultValue>
                </parameter>

                <parameter name="maxTemperatureCase1" type="int">
                    <displayName>Maximum temperature (case 1)</displayName>
                    <description>Maximum temperature average temperature should be</description>
                    <defaultValue>8</defaultValue>
                </parameter>

                <parameter name="maxDurationCase2" type="int">
                    <displayName>Maximum duration (case 2)</displayName>
                    <description>Maximum duration of between time windows in seconds</description>
                    <defaultValue>600</defaultValue>
                </parameter>

                <parameter name="minDurationCase2" type="int">
                    <displayName>Minimum duration (case 2)</displayName>
                    <description>Minimum duration of between time windows in seconds</description>
                    <defaultValue>120</defaultValue>
                </parameter>

                <parameter name="minTemperatureCase2" type="int">
                    <displayName>Minimum temperature (case 2)</displayName>
                    <description>Minimum temperature average temperature should be</description>
                    <defaultValue>2</defaultValue>
                </parameter>

                <parameter name="maxTemperatureCase2" type="int">
                    <displayName>Maximum temperature (case 2)</displayName>
                    <description>Maximum temperature average temperature should be</description>
                    <defaultValue>12</defaultValue>
                </parameter>

                <parameter name="maxDurationCase3" type="int">
                    <displayName>Maximum duration (case 3)</displayName>
                    <description>Maximum duration of between time windows in seconds</description>
                    <defaultValue>900</defaultValue>
                </parameter>

                <parameter name="minDurationCase3" type="int">
                    <displayName>Minimum duration (case 3)</displayName>
                    <description>Minimum duration of between time windows in seconds</description>
                    <defaultValue>600</defaultValue>
                </parameter>

                <parameter name="minTemperatureCase3" type="int">
                    <displayName>Minimum temperature (case 3)</displayName>
                    <description>Minimum temperature average temperature should be</description>
                    <defaultValue>2</defaultValue>
                </parameter>

                <parameter name="maxTemperatureCase3" type="int">
                    <displayName>Maximum temperature (case 3)</displayName>
                    <description>Maximum temperature average temperature should be</description>
                    <defaultValue>14</defaultValue>
                </parameter>

                <parameter name="minDurationCase4" type="int">
                    <displayName>Minimum duration (case 4)</displayName>
                    <description>Minimum duration of between time windows in seconds</description>
                    <defaultValue>900</defaultValue>
                </parameter>

            </parameters>
        </template>

        <template name="DoorOpenTimeAnalysis">
            <description>Trigger alert by specifying only minimum value</description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                    @Plan:name('TemperatureAnalysis')

                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */

                    @Import('deviceHealthMainStream:1.0.0')
                    define stream deviceHealthMainStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature double, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                    @Import('deviceDoorMainStream:1.0.0')
                    define stream deviceDoorMainStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration long);

                    @Export('alertStream:1.0.0')
                    define stream alertStream (smartDeviceId int, gatewayId int, totalDuration long, averageTemperature double);

                    @info(name = 'query')
                    from deviceDoorMainStream#window.time($windowSize) join deviceHealthMainStream#window.time($windowSize)
                    on deviceDoorMainStream.smartDeviceId == deviceHealthMainStream.smartDeviceId
                    select deviceHealthMainStream.smartDeviceId  as smartDeviceId,
                    deviceDoorMainStream.gatewayId,
                    sum(deviceDoorMainStream.doorOpenDuration) as totalDuration,
                    avg(deviceHealthMainStream.temperature) as averageTemperature
                    group by deviceHealthMainStream.smartDeviceId
                    having totalDuration > $maxDuration and
                    (time:timestampInMilliseconds(time:currentTime(),'HH:mm:ss') >
                                      time:timestampInMilliseconds('$startTime','HH:mm:ss')
                                     and time:timestampInMilliseconds(time:currentTime(),'HH:mm:ss') <
                                      time:timestampInMilliseconds('$endTime','HH:mm:ss'))
                    insert into alertStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time eg:-60 min</description>
                    <defaultValue>32 min</defaultValue>
                </parameter>
                <parameter name="maxDuration" type="int">
                    <displayName>Maximum duration</displayName>
                    <description>Maximum door open duration (specify value in seconds)</description>
                    <defaultValue>300</defaultValue>
                </parameter>
                <parameter name="startTime" type="string">
                    <displayName>Starting time</displayName>
                    <description>Value should be in 'HH:mm:ss' format</description>
                    <defaultValue>08:00:00</defaultValue>
                </parameter>
                <parameter name="endTime" type="string">
                    <displayName>Ending time</displayName>
                    <description>Value should be in 'HH:mm:ss' format</description>
                    <defaultValue>20:00:00</defaultValue>
                </parameter>
            </parameters>
        </template>

        <template name="DoorAggregate">
            <description>Trigger alert by specifying only minimum value</description>
            <executionPlan>
                <![CDATA[
                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */
                    @Import('deviceDoorStream:1.0.0')
                    define stream deviceDoorStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration int);

					@Export('deviceDoorMainStream:1.0.0')
					define stream deviceDoorMainStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration long);

                    @info(name = 'query')
                    from deviceDoorStream#window.cron('$windowSize')
					select deviceDoorStream.smartDeviceDoorStatusId, deviceDoorStream.smartDeviceId, deviceDoorStream.gatewayId, deviceDoorStream.eventTime,
					deviceDoorStream.EventId, deviceDoorStream.doorOpen, deviceDoorStream.createdOn, sum(deviceDoorStream.doorOpenDuration) as doorOpenDuration
                    group by deviceDoorStream.smartDeviceId
                    insert into deviceDoorMainStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time</description>
                    <defaultValue>0 */30 * * * ?</defaultValue>
                </parameter>
            </parameters>
        </template>


        <template name="HealthAggregate">
            <description>Trigger alert by specifying only minimum value</description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                @Plan:name('HealthAggregate')

                @Import('deviceHealthStream:1.0.0')
                define stream deviceHealthStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature float, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                @Export('deviceHealthMainStream:1.0.0')
                define stream deviceHealthMainStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature double, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                @info(name = 'query')
                from deviceHealthStream#window.cron('$windowSize')
                select deviceHealthStream.smartDeviceHealthRecordId, deviceHealthStream.smartDeviceId, deviceHealthStream.gatewayId, deviceHealthStream.eventId, deviceHealthStream.eventTime,
                deviceHealthStream.eventTypeId, deviceHealthStream.lightIntensity, avg(deviceHealthStream.temperature) as temperature,
                deviceHealthStream.humidity, deviceHealthStream.soundLevel, deviceHealthStream.isDoorOpen, deviceHealthStream.powerStatusId, deviceHealthStream.batteryLevel, deviceHealthStream.createdOn
                group by deviceHealthStream.smartDeviceId
                insert into deviceHealthMainStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time</description>
                    <defaultValue>0 */30 * * * ?</defaultValue>
                </parameter>
            </parameters>
        </template>
    </templates>
    <streams>
        <stream>
            {
            "streamId": "deviceHealthStream:1.0.0",
            "name": "deviceHealthStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "metaData": [],
            "correlationData": [],
            "payloadData": [
            {
            "name": "smartDeviceHealthRecordId",
            "type": "INT"
            },
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "eventId",
            "type": "INT"
            },
            {
            "name": "eventTime",
            "type": "STRING"
            },
            {
            "name": "eventTypeId",
            "type": "INT"
            },
            {
            "name": "lightIntensity",
            "type": "INT"
            },
            {
            "name": "temperature",
            "type": "FLOAT"
            },
            {
            "name": "humidity",
            "type": "FLOAT"
            },
            {
            "name": "soundLevel",
            "type": "FLOAT"
            },
            {
            "name": "isDoorOpen",
            "type": "BOOL"
            },
            {
            "name": "powerStatusId",
            "type": "INT"
            },
            {
            "name": "batteryLevel",
            "type": "INT"
            },
            {
            "name": "createdOn",
            "type": "STRING"
            }
            ]
            }
        </stream>
        <stream>
            {
            "streamId": "deviceDoorStream:1.0.0",
            "name": "deviceDoorStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "metaData": [],
            "correlationData": [],
            "payloadData": [
            {
            "name": "smartDeviceDoorStatusId",
            "type": "INT"
            },
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "eventTime",
            "type": "STRING"
            },
            {
            "name": "EventId",
            "type": "INT"
            },
            {
            "name": "doorOpen",
            "type": "STRING"
            },
            {
            "name": "createdOn",
            "type": "STRING"
            },
            {
            "name": "doorOpenDuration",
            "type": "INT"
            }
            ]
            }
        </stream>
        <stream>
            {
            "name": "deviceDoorMainStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "payloadData": [
            {
            "name": "smartDeviceDoorStatusId",
            "type": "INT"
            },
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "eventTime",
            "type": "STRING"
            },
            {
            "name": "EventId",
            "type": "INT"
            },
            {
            "name": "doorOpen",
            "type": "STRING"
            },
            {
            "name": "createdOn",
            "type": "STRING"
            },
            {
            "name": "doorOpenDuration",
            "type": "LONG"
            }
            ]
            }
        </stream>
        <stream>
            {
            "name": "deviceHealthMainStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "payloadData": [
            {
            "name": "smartDeviceHealthRecordId",
            "type": "INT"
            },
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "eventId",
            "type": "INT"
            },
            {
            "name": "eventTime",
            "type": "STRING"
            },
            {
            "name": "eventTypeId",
            "type": "INT"
            },
            {
            "name": "lightIntensity",
            "type": "INT"
            },
            {
            "name": "temperature",
            "type": "DOUBLE"
            },
            {
            "name": "humidity",
            "type": "FLOAT"
            },
            {
            "name": "soundLevel",
            "type": "FLOAT"
            },
            {
            "name": "isDoorOpen",
            "type": "BOOL"
            },
            {
            "name": "powerStatusId",
            "type": "INT"
            },
            {
            "name": "batteryLevel",
            "type": "INT"
            },
            {
            "name": "createdOn",
            "type": "STRING"
            }
            ]
            }
        </stream>
        <stream>
            {
            "name": "alertStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "payloadData": [
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "totalDuration",
            "type": "LONG"
            },
            {
            "name": "averageTemperature",
            "type": "DOUBLE"
            }
            ]
            }
        </stream>
    </streams>
</templateDomain>