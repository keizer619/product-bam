<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ Copyright (c) 2015, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<templateDomain name="TemperatureAnalysis">
    <description>Temperature Analysis Description</description>
    <templates>
        <template name="TemperatureAnalysis1">
            <description>Trigger alert by specifying minimum maximum temperature values and maximum total duration
                value
            </description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                    @Plan:name('TemperatureAnalysis')

                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */



                    @Import('deviceHealthStream:1.0.0')
                    define stream deviceHealthStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature float, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                    @Import('deviceDoorStream:1.0.0')
                    define stream deviceDoorStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration int);

                    @Export('alertStream:1.0.0')
                    define stream alertStream (smartDeviceId int, gatewayId int, totalDuration long, averageTemperature double);

                    @info(name = 'query')
                    from deviceDoorStream#window.timeBatch($windowSize) join deviceHealthStream#window.timeBatch($windowSize)
                    on deviceDoorStream.smartDeviceId == deviceHealthStream.smartDeviceId
                    select deviceHealthStream.smartDeviceId  as smartDeviceId,
                    deviceDoorStream.gatewayId,
                    sum(deviceDoorStream.doorOpenDuration) as totalDuration,
                    avg(deviceHealthStream.temperature) as averageTemperature
                    group by deviceHealthStream.smartDeviceId
                    having totalDuration < $maxDuration and ( averageTemperature > $maxTemperature or averageTemperature < $minTemperature)
                    insert into alertStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time eg:-60 min</description>
                    <defaultValue>30 min</defaultValue>
                </parameter>

                <parameter name="maxDuration" type="int">
                    <displayName>Maximum duration</displayName>
                    <description>Maximum duration of between time windows in seconds</description>
                    <defaultValue>120</defaultValue>
                </parameter>

                <parameter name="minTemperature" type="int">
                    <displayName>Minimum temperature</displayName>
                    <description>Minimum temperature average temperature should be</description>
                    <defaultValue>2</defaultValue>
                </parameter>

                <parameter name="maxTemperature" type="int">
                    <displayName>Maximum temperature</displayName>
                    <description>Maximum temperature average temperature should be</description>
                    <defaultValue>8</defaultValue>
                </parameter>
            </parameters>
        </template>

        <template name="TemperatureAnalysis2">
            <description>Trigger alert by specifying minimum maximum temperature and total duration values</description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                    @Plan:name('TemperatureAnalysis')

                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */



                    @Import('deviceHealthStream:1.0.0')
                    define stream deviceHealthStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature float, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                    @Import('deviceDoorStream:1.0.0')
                    define stream deviceDoorStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration int);

                    @Export('alertStream:1.0.0')
                    define stream alertStream (smartDeviceId int, gatewayId int, totalDuration long, averageTemperature double);

                    @info(name = 'query')
                    from deviceDoorStream#window.timeBatch($windowSize) join deviceHealthStream#window.timeBatch($windowSize)
                    on deviceDoorStream.smartDeviceId == deviceHealthStream.smartDeviceId
                    select deviceHealthStream.smartDeviceId  as smartDeviceId,
                    deviceDoorStream.gatewayId,
                    sum(deviceDoorStream.doorOpenDuration) as totalDuration,
                    avg(deviceHealthStream.temperature) as averageTemperature
                    group by deviceHealthStream.smartDeviceId
                    having (totalDuration < $maxDuration and totalDuration > $minDuration ) and ( averageTemperature > $maxTemperature and averageTemperature < $minTemperature)
                    insert into alertStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time eg:-60 min</description>
                    <defaultValue>30 min</defaultValue>
                </parameter>

                <parameter name="maxDuration" type="int">
                    <displayName>Maximum duration</displayName>
                    <description>Maximum duration of between time windows in seconds</description>
                    <defaultValue>600</defaultValue>
                </parameter>

                <parameter name="minDuration" type="int">
                    <displayName>Minimum duration</displayName>
                    <description>Minimum duration of between time windows in seconds</description>
                    <defaultValue>120</defaultValue>
                </parameter>

                <parameter name="minTemperature" type="int">
                    <displayName>Minimum temperature</displayName>
                    <description>Minimum temperature average temperature should be</description>
                    <defaultValue>2</defaultValue>
                </parameter>

                <parameter name="maxTemperature" type="int">
                    <displayName>Maximum temperature</displayName>
                    <description>Maximum temperature average temperature should be</description>
                    <defaultValue>12</defaultValue>
                </parameter>
            </parameters>
        </template>


        <template name="TemperatureAnalysis3">
            <description>Trigger alert by specifying only maximum value</description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                    @Plan:name('TemperatureAnalysis')

                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */



                    @Import('deviceHealthStream:1.0.0')
                    define stream deviceHealthStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature float, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                    @Import('deviceDoorStream:1.0.0')
                    define stream deviceDoorStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration int);

                    @Export('alertStream:1.0.0')
                    define stream alertStream (smartDeviceId int, gatewayId int, totalDuration long, averageTemperature double);

                    @info(name = 'query')
                    from deviceDoorStream#window.timeBatch($windowSize) join deviceHealthStream#window.timeBatch($windowSize)
                    on deviceDoorStream.smartDeviceId == deviceHealthStream.smartDeviceId
                    select deviceHealthStream.smartDeviceId  as smartDeviceId,
                    deviceDoorStream.gatewayId,
                    sum(deviceDoorStream.doorOpenDuration) as totalDuration,
                    avg(deviceHealthStream.temperature) as averageTemperature
                    group by deviceHealthStream.smartDeviceId
                    having  $maxTemperature < totalDuration
                    insert into alertStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time eg:-60 min</description>
                    <defaultValue>60 min</defaultValue>
                </parameter>
                <parameter name="maxTemperature" type="int">
                    <displayName>Maximum temperature</displayName>
                    <description>Maximum temperature average temperature should be in seconds</description>
                    <defaultValue>900</defaultValue>
                </parameter>
            </parameters>
        </template>

        <template name="DoorOpenTimeAnalysis">
            <description>Trigger alert by specifying only minimum value</description>
            <executionPlan>
                <![CDATA[
               /* Enter a unique ExecutionPlan */
                    @Plan:name('TemperatureAnalysis')

                    /* Enter a unique description for ExecutionPlan */
                    -- @Plan:description('ExecutionPlan')

                    /* define streams/tables and write queries here ... */

                    @Import('deviceHealthStream:1.0.0')
                    define stream deviceHealthStream (smartDeviceHealthRecordId int, smartDeviceId int, gatewayId int, eventId int, eventTime string, eventTypeId int, lightIntensity int, temperature float, humidity float, soundLevel float, isDoorOpen bool, powerStatusId int, batteryLevel int, createdOn string);

                    @Import('deviceDoorStream:1.0.0')
                    define stream deviceDoorStream (smartDeviceDoorStatusId int, smartDeviceId int, gatewayId int, eventTime string, EventId int, doorOpen string, createdOn string, doorOpenDuration int);

                    @Export('alertStream:1.0.0')
                    define stream alertStream (smartDeviceId int, gatewayId int, totalDuration long, averageTemperature double);

                    @info(name = 'query')
                    from deviceDoorStream#window.timeBatch($windowSize) join deviceHealthStream#window.timeBatch($windowSize)
                    on deviceDoorStream.smartDeviceId == deviceHealthStream.smartDeviceId
                    select deviceHealthStream.smartDeviceId  as smartDeviceId,
                    deviceDoorStream.gatewayId,
                    sum(deviceDoorStream.doorOpenDuration) as totalDuration,
                    avg(deviceHealthStream.temperature) as averageTemperature
                    group by deviceHealthStream.smartDeviceId
                    having totalDuration > $maxDuration and
                    (time:timestampInMilliseconds(time:currentTime(),'HH:mm:ss') >
                                      time:timestampInMilliseconds('$startTime','HH:mm:ss')
                                     and time:timestampInMilliseconds(time:currentTime(),'HH:mm:ss') <
                                      time:timestampInMilliseconds('$endTime','HH:mm:ss'))
                    insert into alertStream;
                 ]]>
            </executionPlan>
            <parameters>
                <parameter name="windowSize" type="time">
                    <displayName>Time batch window size</displayName>
                    <description>Value type should be time eg:-60 min</description>
                    <defaultValue>60 min</defaultValue>
                </parameter>
                <parameter name="maxDuration" type="int">
                    <displayName>Maximum duration</displayName>
                    <description>Maximum door open duration (specify value in seconds)</description>
                    <defaultValue>300</defaultValue>
                </parameter>
                <parameter name="startTime" type="string">
                    <displayName>Starting time</displayName>
                    <description>Value should be in 'HH:mm:ss' format</description>
                    <defaultValue>08:00:00</defaultValue>
                </parameter>
                <parameter name="endTime" type="string">
                    <displayName>Ending time</displayName>
                    <description>Value should be in 'HH:mm:ss' format</description>
                    <defaultValue>20:00:00</defaultValue>
                </parameter>
            </parameters>
        </template>


    </templates>
    <streams>
        <stream>
            {
            "streamId": "deviceHealthStream:1.0.0",
            "name": "deviceHealthStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "metaData": [],
            "correlationData": [],
            "payloadData": [
            {
            "name": "smartDeviceHealthRecordId",
            "type": "INT"
            },
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "eventId",
            "type": "INT"
            },
            {
            "name": "eventTime",
            "type": "STRING"
            },
            {
            "name": "eventTypeId",
            "type": "INT"
            },
            {
            "name": "lightIntensity",
            "type": "INT"
            },
            {
            "name": "temperature",
            "type": "FLOAT"
            },
            {
            "name": "humidity",
            "type": "FLOAT"
            },
            {
            "name": "soundLevel",
            "type": "FLOAT"
            },
            {
            "name": "isDoorOpen",
            "type": "BOOL"
            },
            {
            "name": "powerStatusId",
            "type": "INT"
            },
            {
            "name": "batteryLevel",
            "type": "INT"
            },
            {
            "name": "createdOn",
            "type": "STRING"
            }
            ]
            }
        </stream>
        <stream>
            {
            "streamId": "deviceDoorStream:1.0.0",
            "name": "deviceDoorStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "metaData": [],
            "correlationData": [],
            "payloadData": [
            {
            "name": "smartDeviceDoorStatusId",
            "type": "INT"
            },
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "eventTime",
            "type": "STRING"
            },
            {
            "name": "EventId",
            "type": "INT"
            },
            {
            "name": "doorOpen",
            "type": "STRING"
            },
            {
            "name": "createdOn",
            "type": "STRING"
            },
            {
            "name": "doorOpenDuration",
            "type": "INT"
            }
            ]
            }
        </stream>
        <stream>
            {
            "name": "alertStream",
            "version": "1.0.0",
            "nickName": "",
            "description": "",
            "payloadData": [
            {
            "name": "smartDeviceId",
            "type": "INT"
            },
            {
            "name": "gatewayId",
            "type": "INT"
            },
            {
            "name": "totalDuration",
            "type": "LONG"
            },
            {
            "name": "averageTemperature",
            "type": "DOUBLE"
            }
            ]
            }
        </stream>
    </streams>
</templateDomain>